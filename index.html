<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turning Point AI - ä¸´ç•Œç‚¹ç§‘æŠ€</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
    <style>
        /* é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --accent-color: #10b981;
            --v5-color: #8b5cf6;
            --v5-glow: rgba(139, 92, 246, 0.3);
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --header-height: 60px;
            --sidebar-width: 280px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        /* åŠ è½½ç•Œé¢ */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid var(--card-border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ä¸»åº”ç”¨å®¹å™¨ */
        #app {
            height: 100vh;
            display: flex;
            position: relative;
        }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: var(--sidebar-width);
            background: var(--card-bg);
            border-right: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: -100%;
            height: 100vh;
            z-index: 1000;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        #sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* å¯¹è¯åˆ—è¡¨ */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
        }

        .conversation-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary-color);
        }

        .conversation-title {
            font-weight: 500;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-preview {
            font-size: 0.875rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* æ–°å»ºå¯¹è¯æŒ‰é’® */
        .new-chat-btn {
            margin: 15px;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .new-chat-btn:hover {
            background: var(--primary-dark);
        }

        /* ä¸»èŠå¤©åŒºåŸŸ */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        #header {
            height: var(--header-height);
            background: var(--card-bg);
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s ease;
            position: relative;
        }

        .icon-btn:hover {
            color: var(--text-primary);
        }

        .v5-icon {
            color: var(--v5-color);
            animation: v5-glow 2s infinite alternate;
        }

        @keyframes v5-glow {
            from { filter: drop-shadow(0 0 2px var(--v5-glow)); }
            to { filter: drop-shadow(0 0 8px var(--v5-glow)); }
        }

        /* æ¨¡å‹æŒ‡ç¤ºå™¨ */
        .model-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            margin-left: 10px;
        }

        .v5-indicator {
            background: rgba(139, 92, 246, 0.2);
            color: var(--v5-color);
            border: 1px solid var(--v5-color);
        }

        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-content {
            padding: 16px;
            border-radius: var(--radius-lg);
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .message.ai .message-content {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-bottom-left-radius: var(--radius-sm);
        }

        .message.ai.v5 .message-content {
            border-color: var(--v5-color);
            background: rgba(139, 92, 246, 0.05);
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        /* ä»£ç å—æ ·å¼ */
        .code-block {
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-md);
            margin: 10px 0;
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        .code-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--card-border);
        }

        .code-language {
            font-weight: 500;
            color: var(--accent-color);
        }

        .code-content {
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
            tab-size: 4;
        }

        .copy-code-btn {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .copy-code-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .preview-btn {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            margin-left: 5px;
        }

        .preview-btn:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        /* å†…è”ä»£ç æ ·å¼ */
        .inline-code {
            background: rgba(0, 0, 0, 0.3);
            color: var(--accent-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid var(--card-border);
        }

        /* HTMLé¢„è§ˆæ¨¡æ€æ¡† */
        .html-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .html-preview-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 90%;
            height: 80%;
            max-width: 900px;
            padding: 0;
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }

        /* æµå¼æ‰“å­—æ•ˆæœ */
        .streaming-cursor {
            display: inline-block;
            width: 3px;
            height: 1em;
            background: var(--accent-color);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* è¾“å…¥åŒºåŸŸ */
        #input-area {
            padding: 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--card-border);
            position: sticky;
            bottom: 0;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        #message-input {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: border-color 0.2s ease;
        }

        #message-input:focus {
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.08);
        }

        #message-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        /* æ¨¡å¼é€‰æ‹©å™¨ */
        .mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mode-btn.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* åŠŸèƒ½æŒ‰é’®ç»„ */
        .function-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-btn.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .toggle-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
        }

        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åœæ­¢ç”ŸæˆæŒ‰é’® */
        .stop-btn {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger-color);
            border-radius: var(--radius-md);
            color: var(--danger-color);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stop-btn:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* è®¾ç½®é¢æ¿ */
        #settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            height: 100vh;
            background: var(--card-bg);
            border-left: 1px solid var(--card-border);
            z-index: 1001;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
            padding-bottom: 80px;
        }
        
        #settings-panel.active {
            right: 0;
        }
        
        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-content {
            padding: 20px;
        }
        
        .setting-item {
            margin-bottom: 25px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .setting-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        /* é‚€è¯·ç è¾“å…¥ */
        .invite-code-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .v5-unlocked {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid var(--v5-color);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-top: 10px;
        }

        /* è¯­è¨€åˆ‡æ¢å™¨ */
        .language-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .lang-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* å¼€å‘æ—¥å¿— */
        .development-log {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-date {
            color: var(--accent-color);
            font-weight: 500;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: rgba(239, 68, 68, 0.15);
            border-left: 3px solid var(--danger-color);
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: var(--radius-md);
            color: #fca5a5;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 85%;
            }

            #header {
                padding: 0 15px;
            }

            #chat-container {
                padding: 15px;
            }

            #input-area {
                padding: 15px;
            }

            .message {
                max-width: 90%;
            }

            .mode-selector, .function-buttons {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
            }

            .mode-btn, .toggle-btn, .stop-btn {
                white-space: nowrap;
            }
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .conversations-list::-webkit-scrollbar,
        #chat-container::-webkit-scrollbar {
            width: 4px;
        }

        .conversations-list::-webkit-scrollbar-track,
        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversations-list::-webkit-scrollbar-thumb,
        #chat-container::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 2px;
        }

        /* å“ç‰Œå£°æ˜ */
        .brand-footer {
            padding: 15px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            border-top: 1px solid var(--card-border);
        }

        .brand-footer strong {
            color: var(--accent-color);
        }

        /* æ»šåŠ¨æç¤º */
        .scroll-hint {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            display: none;
            z-index: 10;
        }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            z-index: 9999;
            animation: slideDown 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            box-shadow: var(--shadow-md);
            max-width: 80%;
            text-align: center;
        }

        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading">
        <div class="loader"></div>
        <div style="color: var(--text-secondary); margin-top: 10px;">Turning Point AI æ­£åœ¨å¯åŠ¨...</div>
    </div>

    <!-- HTMLé¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="html-preview-modal" id="html-preview-modal">
        <div class="html-preview-content">
            <div class="preview-header">
                <h3 style="margin: 0;">HTML é¢„è§ˆ</h3>
                <button class="close-sidebar" onclick="closeHtmlPreview()">Ã—</button>
            </div>
            <iframe class="preview-iframe" id="preview-iframe" sandbox="allow-scripts"></iframe>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" style="display: none;">
        <!-- ä¾§è¾¹æ  -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h2>å¯¹è¯å†å²</h2>
                <button class="close-sidebar" onclick="toggleSidebar()">Ã—</button>
            </div>
            
            <div class="conversations-list" id="conversations-list">
                <!-- å¯¹è¯é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <button class="new-chat-btn" onclick="newConversation()">
                <span style="font-size: 1.2rem;">+</span> æ–°å¯¹è¯
            </button>
            
            <div class="brand-footer">
                Â© 2025 <strong>ä¸´ç•Œç‚¹ç§‘æŠ€</strong> è‡ªç ”å¼€å‘
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div id="settings-panel">
            <div class="settings-header">
                <h3>è®¾ç½®</h3>
                <button class="close-sidebar" onclick="toggleSettings()">Ã—</button>
            </div>
            
            <div class="settings-content">
                <div class="language-switcher">
                    <button class="lang-btn active" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
                    <button class="lang-btn" onclick="switchLanguage('en')">English</button>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">æ¨¡å‹çŠ¶æ€</label>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: var(--radius-md);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 12px; height: 12px; background: var(--accent-color); border-radius: 50%;"></div>
                            <span style="font-weight: 500;" id="current-model-display">TurningPointY2 (æ ‡å‡†æ¨¡å¼)</span>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            <div>â€¢ TurningPointY2ï¼šæ ‡å‡†å“åº”æ¨¡å¼</div>
                            <div>â€¢ TurningPointZ1ï¼šæ·±åº¦æ€è€ƒæ¨¡å¼</div>
                            <div id="v5-model-info" style="display: none;">â€¢ TurningPointV5ï¼šæœ€æ–°ç®—æ³•æ¨¡å‹ï¼ˆæµ‹è¯•ï¼‰ (éœ€é‚€è¯·ç )</div>
                            <div>â€¢ æ·±åº¦æ€è€ƒå’ŒV5æ¨¡å¼ä¸èƒ½åŒæ—¶å¼€å¯</div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">TurningPointV5 æ¿€æ´»</label>
                    <div id="v5-activation-form">
                        <input type="text" class="invite-code-input" id="invite-code-input" placeholder="è¾“å…¥é‚€è¯·ç ï¼š">
                        <button class="action-btn" onclick="activateV5()" style="width: 100%;">ğŸš€ æ¿€æ´» TurningPointV5</button>
                    </div>
                    
                    <div id="v5-activated" class="v5-unlocked" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 12px; height: 12px; background: var(--v5-color); border-radius: 50%;"></div>
                            <span style="font-weight: 500; color: var(--v5-color);">TurningPointV5 å·²æ¿€æ´»ï¼</span>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--v5-color);">
                            â€¢ ç‚¹å‡»å³ä¸Šè§’ğŸ¤–å›¾æ ‡åˆ‡æ¢<br>
                        </div>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">è¡Œä¸ºè®¾ç½®</label>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="auto-scroll" checked>
                            <span>è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="code-formatting" checked>
                            <span>å¯ç”¨ä»£ç æ ¼å¼åŒ–</span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">å¼€å‘æ—¥å¿—</label>
                    <div class="development-log">
                        <div class="log-entry"><span class="log-date">2025.11.15</span> - TurningPointV5æœ€æ–°ç®—æ³•æ¨¡å‹ï¼ˆç›®å‰ç»´ä¿®ä¸­ï¼‰</div>
                        <div class="log-entry"><span class="log-date">2025.11.02</span> - æ·±åº¦æ€è€ƒæ¨¡å¼Z1å‘å¸ƒ</div>
                        <div class="log-entry"><span class="log-date">2024.11.01</span> - å¤šè¯­è¨€ç³»ç»Ÿä¸Šçº¿ï¼Œï¼ˆç›®å‰ç»´ä¿®ä¸­ï¼‰</div>
                        <div class="log-entry"><span class="log-date">2025.10.28</span> - ä»£ç æ ¼å¼åŒ–å¼•æ“å¼€å‘å®Œæˆ</div>
                        <div class="log-entry"><span class="log-date">2025.10.25</span> - TurningPointY2æ ‡å‡†ç‰ˆå‘å¸ƒ</div>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">æ•°æ®ç®¡ç†</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="action-btn" onclick="exportAllData()">ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                        <button class="action-btn" onclick="clearAllData()" style="background: rgba(239, 68, 68, 0.15); color: var(--danger-color);">
                            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div id="main-content">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <div id="header">
                <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
                
                <div class="logo">
                    <span style="font-size: 1.5rem;">ğŸ¤–</span>
                    <span class="logo-text">Turning Point AI</span>
                    <span class="model-indicator" id="model-indicator">TurningPointY2</span>
                </div>
                
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleSettings()" title="è®¾ç½®">
                        âš™ï¸
                    </button>
                    <button class="icon-btn" onclick="toggleDeepThinking()" title="æ·±åº¦æ€è€ƒ" id="deep-thinking-icon">
                        ğŸ§ 
                    </button>
                    <button class="icon-btn v5-icon" onclick="toggleV5Model()" title="åˆ‡æ¢TurningPointV5" id="v5-icon" style="display: none;">
                        ğŸ¤–
                    </button>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div id="chat-container">
                <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message ai">
                    <div class="message-header">
                        <span class="message-sender">Turning Point AI</span>
                        <span class="message-time">ç°åœ¨</span>
                    </div>
                    <div class="message-content">
                        <div style="line-height: 1.8;">
                            <p>ä½ å¥½ï¼æˆ‘æ˜¯ <strong>Turning Point</strong>ï¼Œä¸€ä¸ªç”± <strong>ä¸´ç•Œç‚¹ç§‘æŠ€</strong> å®Œå…¨è‡ªç ”å¼€å‘çš„AIåŠ©æ‰‹ã€‚</p>
                            <p>æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”é—®é¢˜ã€è¿›è¡Œå¯¹è¯ï¼Œå¹¶æ”¯æŒæ·±åº¦æ€è€ƒæ¨¡å¼å’Œå¤šæ¨¡å¼é€‰æ‹©ã€‚</p>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: var(--radius-md);">
                                <div style="color: var(--primary-color); font-weight: 500; margin-bottom: 5px;">ğŸš€ æ–°åŠŸèƒ½æç¤º</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    â€¢ æ”¯æŒä»£ç æ ¼å¼åŒ–æ˜¾ç¤º<br>
                                    â€¢ å¤šæ¨¡å¼é€‰æ‹©ï¼ˆç¼–ç¨‹/å¿ƒç†/çµæ„Ÿ/å†™ä½œï¼‰<br>
                                    â€¢ TurningPointV5é‡å­æ¨¡å‹<br>
                                    â€¢ å¤šè¯­è¨€æ”¯æŒ
                                </div>
                            </div>
                            <p style="margin-top: 10px; color: var(--accent-color); font-size: 0.9em;">
                                ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ¶ˆæ¯æ—çš„æŒ‰é’®å¯ä»¥å¤åˆ¶æˆ–é‡æ–°å‘é€æ¶ˆæ¯ã€‚
                            </p>
                        </div>
                        <div class="message-actions">
                            <button class="action-btn" onclick="copyMessage(this)">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div id="input-area">
                <!-- æ¨¡å¼é€‰æ‹©å™¨ -->
                <div class="mode-selector" id="mode-selector">
                    <button class="mode-btn active" onclick="switchMode('general')" data-mode="general">
                        <span>ğŸ’¬</span> <span>æ™®é€šå¯¹è¯</span>
                    </button>
                    <button class="mode-btn" onclick="switchMode('programming')" data-mode="programming">
                        <span>ğŸ’»</span> <span>ç¼–ç¨‹æ¨¡å¼</span>
                    </button>
                    <button class="mode-btn" onclick="switchMode('psychology')" data-mode="psychology">
                        <span>ğŸ§ </span> <span>å¿ƒç†å’¨è¯¢</span>
                    </button>
                    <button class="mode-btn" onclick="switchMode('inspiration')" data-mode="inspiration">
                        <span>âœ¨</span> <span>çµæ„Ÿæä¾›</span>
                    </button>
                    <button class="mode-btn" onclick="switchMode('writing')" data-mode="writing">
                        <span>ğŸ“</span> <span>å†™ä½œæ¨¡å¼</span>
                    </button>
                </div>

                <!-- åŠŸèƒ½æŒ‰é’® -->
                <div class="function-buttons" id="function-buttons">
                    <button class="toggle-btn" onclick="toggleDeepThinking()" id="deep-thinking-btn">
                        <span>ğŸ§ </span>
                        <span>æ·±åº¦æ€è€ƒ</span>
                    </button>
                    <button class="stop-btn" onclick="stopGeneration()" id="stop-btn" style="display: none;">
                        <span>â¹ï¸</span>
                        <span>åœæ­¢ç”Ÿæˆ</span>
                    </button>
                </div>

                <!-- è¾“å…¥æ¡† -->
                <div class="input-container">
                    <textarea 
                        id="message-input" 
                        placeholder="å‘Turning Pointæé—®..." 
                        rows="1"
                        onkeydown="handleInputKeydown(event)"
                        oninput="autoResizeTextarea(this)"
                    ></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">
                        â†‘
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== çŠ¶æ€ç®¡ç† ====================
        const state = {
            // å¯¹è¯ç®¡ç†
            currentConversationId: null,
            conversations: {},
            
            // åŠŸèƒ½çŠ¶æ€
            isStreaming: false,
            deepThinking: false,
            currentMode: 'general',
            
            // V5æ¨¡å‹
            v5Activated: false,
            v5Enabled: false,
            
            // APIé…ç½®
            apiKey: 'sk-d82252783f064042a1d4ad9c7f69b72a',
            currentModel: 'TurningPointY2',
            
            // è®¾ç½®
            settings: {
                autoScroll: true,
                codeFormatting: true,
                language: 'zh'
            },
            
            // æ»šåŠ¨æ§åˆ¶
            userScrolled: false,
            scrollTimeout: null,
            
            // æµå¼æ§åˆ¶
            currentStreamController: null
        };

        // ==================== åˆå§‹åŒ–å‡½æ•° ====================
        function initApp() {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            loadFromLocalStorage();
            
            // åˆå§‹åŒ–è¯­è¨€
            const savedLang = localStorage.getItem('turningPoint_language');
            if (savedLang) {
                state.settings.language = savedLang;
                updateLanguageUI(savedLang);
            }
            
            // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªå¯¹è¯
            if (Object.keys(state.conversations).length === 0) {
                newConversation();
            } else {
                // åŠ è½½æœ€åä¸€ä¸ªå¯¹è¯
                const lastConversationId = localStorage.getItem('turningPoint_lastConversation');
                if (lastConversationId && state.conversations[lastConversationId]) {
                    loadConversation(lastConversationId);
                } else {
                    const firstId = Object.keys(state.conversations)[0];
                    loadConversation(firstId);
                }
            }
            
            // æ›´æ–°UI
            updateConversationsList();
            updateSettingsUI();
            initScrollListener();
            updateModelDisplay();
            checkV5Activation();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('auto-scroll').addEventListener('change', function() {
                state.settings.autoScroll = this.checked;
                saveSettings();
            });
            
            document.getElementById('code-formatting').addEventListener('change', function() {
                state.settings.codeFormatting = this.checked;
                saveSettings();
            });
        }

        // ==================== æ»šåŠ¨æ§åˆ¶ ====================
        function initScrollListener() {
            const chatContainer = document.getElementById('chat-container');
            
            chatContainer.addEventListener('scroll', function() {
                // å¦‚æœç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨ï¼Œè®¾ç½®æ ‡å¿—
                if (!state.userScrolled) {
                    state.userScrolled = true;
                    
                    // æ˜¾ç¤ºæ»šåŠ¨æç¤º
                    const hint = document.getElementById('scroll-hint');
                    if (hint) {
                        hint.style.display = 'block';
                        setTimeout(() => {
                            hint.style.display = 'none';
                        }, 2000);
                    }
                }
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (state.scrollTimeout) {
                    clearTimeout(state.scrollTimeout);
                }
                
                // è®¾ç½®å®šæ—¶å™¨ï¼Œ3ç§’åé‡ç½®æ»šåŠ¨æ ‡å¿—
                state.scrollTimeout = setTimeout(() => {
                    state.userScrolled = false;
                }, 3000);
            });
        }

        function smartScrollToBottom() {
            if (!state.settings.autoScroll || state.userScrolled) {
                return;
            }
            
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ==================== å¯¹è¯ç®¡ç† ====================
        function newConversation() {
            const conversationId = 'conv_' + Date.now();
            
            state.conversations[conversationId] = {
                id: conversationId,
                title: 'æ–°å¯¹è¯',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            state.currentConversationId = conversationId;
            saveToLocalStorage();
            updateConversationsList();
            loadConversation(conversationId);
            
            // å¦‚æœæ˜¯ä¾§è¾¹æ æ‰“å¼€çŠ¶æ€ï¼Œå…³é—­å®ƒ
            if (document.getElementById('sidebar').classList.contains('active')) {
                toggleSidebar();
            }
        }

        function loadConversation(conversationId) {
            if (!state.conversations[conversationId]) return;
            
            state.currentConversationId = conversationId;
            const conversation = state.conversations[conversationId];
            
            // æ›´æ–°èŠå¤©åŒºåŸŸ
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            
            // æ·»åŠ æ‰€æœ‰æ¶ˆæ¯
            conversation.messages.forEach(msg => {
                if (msg.role === 'user') {
                    addUserMessage(msg.content, msg.id, msg.timestamp);
                } else {
                    const formattedContent = formatMessageContent(msg.content);
                    addAIMessage(formattedContent, msg.id, msg.timestamp, msg.isV5);
                }
            });
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ·»åŠ æ¬¢è¿æ¶ˆæ¯
            if (conversation.messages.length === 0) {
                addAIMessage('ä½ å¥½ï¼æˆ‘æ˜¯ <strong>Turning Point</strong>ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ');
            }
            
            // æ›´æ–°å¯¹è¯åˆ—è¡¨é«˜äº®
            updateConversationsList();
            
            // ä¿å­˜å½“å‰å¯¹è¯IDåˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('turningPoint_lastConversation', conversationId);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                smartScrollToBottom();
            }, 100);
        }

        // ==================== æ¶ˆæ¯ç®¡ç† ====================
        function addUserMessage(content, messageId = null, timestamp = null) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.dataset.messageId = messageId || 'msg_' + Date.now();
            
            const time = timestamp || new Date();
            const timeStr = typeof time === 'string' ? 
                new Date(time).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }) :
                time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">ä½ </span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-content">
                    ${escapeHtml(content)}
                    <div class="message-actions">
                        <button class="action-btn" onclick="resendMessage('${messageDiv.dataset.messageId}')">
                            ğŸ”„ é‡æ–°å‘é€
                        </button>
                        <button class="action-btn" onclick="copyMessage(this)">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            smartScrollToBottom();
            
            // ä¿å­˜åˆ°å½“å‰å¯¹è¯
            if (state.currentConversationId && state.conversations[state.currentConversationId]) {
                const conversation = state.conversations[state.currentConversationId];
                conversation.messages.push({
                    id: messageDiv.dataset.messageId,
                    role: 'user',
                    content: content,
                    timestamp: new Date().toISOString()
                });
                conversation.updatedAt = new Date().toISOString();
                updateConversationTitle(conversation);
                saveToLocalStorage();
            }
        }

        function addAIMessage(content, messageId = null, timestamp = null, isV5 = false) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai' + (isV5 ? ' v5' : '');
            messageDiv.dataset.messageId = messageId || 'msg_' + Date.now();
            
            const time = timestamp || new Date();
            const timeStr = typeof time === 'string' ? 
                new Date(time).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }) :
                time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">Turning Point AI${isV5 ? ' (V5)' : ''}</span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-content">
                    ${content}
                    <div class="message-actions">
                        <button class="action-btn" onclick="copyMessage(this)">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                        <button class="action-btn" onclick="regenerateMessage('${messageDiv.dataset.messageId}')">
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            smartScrollToBottom();
            
            // ä¿å­˜åˆ°å½“å‰å¯¹è¯
            if (state.currentConversationId && state.conversations[state.currentConversationId]) {
                const conversation = state.conversations[state.currentConversationId];
                conversation.messages.push({
                    id: messageDiv.dataset.messageId,
                    role: 'assistant',
                    content: content,
                    timestamp: new Date().toISOString(),
                    isV5: isV5 || false
                });
                conversation.updatedAt = new Date().toISOString();
                updateConversationTitle(conversation);
                saveToLocalStorage();
            }
        }

        // ==================== ä»£ç æ ¼å¼åŒ– ====================
        function formatMessageContent(content) {
            if (!state.settings.codeFormatting) {
                return content;
            }
            
            let formattedContent = content;
            
            // å¤„ç†ä»£ç å—
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            formattedContent = formattedContent.replace(codeBlockRegex, (match, language, code) => {
                const lang = language || 'text';
                const escapedCode = escapeHtml(code);
                const codeId = 'code_' + Date.now();
                
                // å¦‚æœæ˜¯HTMLä»£ç ï¼Œæ·»åŠ é¢„è§ˆæŒ‰é’®
                let previewButton = '';
                if (lang === 'html' || lang === 'htm') {
                    previewButton = `<button class="preview-btn" onclick="previewHtmlCode('${codeId}')">é¢„è§ˆ</button>`;
                    // å­˜å‚¨åŸå§‹ä»£ç 
                    const storageDiv = document.createElement('div');
                    storageDiv.id = codeId;
                    storageDiv.style.display = 'none';
                    storageDiv.textContent = code;
                    document.body.appendChild(storageDiv);
                }
                
                return `
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">${lang}</span>
                            <div>
                                <button class="copy-code-btn" onclick="copyCodeToClipboard(this)">å¤åˆ¶ä»£ç </button>
                                ${previewButton}
                            </div>
                        </div>
                        <pre class="code-content">${escapedCode}</pre>
                    </div>
                `;
            });
            
            // å¤„ç†å†…è”ä»£ç 
            const inlineCodeRegex = /`([^`]+)`/g;
            formattedContent = formattedContent.replace(inlineCodeRegex, '<code class="inline-code">$1</code>');
            
            return formattedContent;
        }

        function copyCodeToClipboard(button) {
            const codeBlock = button.closest('.code-block');
            const codeContent = codeBlock.querySelector('.code-content').textContent;
            
            navigator.clipboard.writeText(codeContent).then(() => {
                const originalText = button.textContent;
                button.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        function previewHtmlCode(codeId) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) return;
            
            const htmlCode = codeElement.textContent;
            const previewIframe = document.getElementById('preview-iframe');
            const previewDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
            
            previewDoc.open();
            previewDoc.write(htmlCode);
            previewDoc.close();
            
            document.getElementById('html-preview-modal').style.display = 'flex';
        }

        function closeHtmlPreview() {
            document.getElementById('html-preview-modal').style.display = 'none';
        }

        // ==================== æ¶ˆæ¯æ“ä½œ ====================
        function resendMessage(messageId) {
            if (state.isStreaming) {
                stopGeneration();
            }
            
            const conversation = state.conversations[state.currentConversationId];
            if (!conversation) return;
            
            const messageIndex = conversation.messages.findIndex(msg => msg.id === messageId);
            if (messageIndex === -1) return;
            
            const userMessage = conversation.messages[messageIndex];
            if (!userMessage || userMessage.role !== 'user') return;
            
            // åˆ é™¤è¯¥æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
            conversation.messages = conversation.messages.slice(0, messageIndex + 1);
            
            // ä»ç•Œé¢ä¸­åˆ é™¤AIçš„å›å¤
            const chatContainer = document.getElementById('chat-container');
            const allMessages = chatContainer.querySelectorAll('.message');
            for (let i = messageIndex + 1; i < allMessages.length; i++) {
                allMessages[i].remove();
            }
            
            // å°†æ¶ˆæ¯å†…å®¹æ”¾å›è¾“å…¥æ¡†
            const input = document.getElementById('message-input');
            input.value = userMessage.content;
            autoResizeTextarea(input);
            input.focus();
            
            conversation.updatedAt = new Date().toISOString();
            saveToLocalStorage();
            updateConversationsList();
            
            showToast('æ¶ˆæ¯å·²å‡†å¤‡é‡æ–°å‘é€');
        }

        async function regenerateMessage(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement || state.isStreaming) return;
            
            const conversation = state.conversations[state.currentConversationId];
            if (!conversation) return;
            
            const messageIndex = conversation.messages.findIndex(msg => msg.id === messageId);
            if (messageIndex === -1) return;
            
            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            const userMessage = conversation.messages[messageIndex - 1];
            if (!userMessage || userMessage.role !== 'user') return;
            
            // åˆ é™¤æ—§çš„AIå›å¤
            conversation.messages.splice(messageIndex, 1);
            messageElement.remove();
            
            // é‡æ–°ç”Ÿæˆ
            state.isStreaming = true;
            document.getElementById('stop-btn').style.display = 'flex';
            
            try {
                const newMessageId = 'msg_' + Date.now();
                const messageDiv = createStreamingMessageContainer(newMessageId);
                
                // å‡†å¤‡æ¶ˆæ¯å†å²
                const previousMessages = conversation.messages.slice(0, messageIndex);
                const apiMessages = [
                    {
                        role: 'system',
                        content: getSystemPrompt()
                    },
                    ...previousMessages.slice(-6).map(msg => ({
                        role: msg.role,
                        content: msg.content
                    })),
                    { role: 'user', content: userMessage.content }
                ];
                
                // è°ƒç”¨API
                const response = await callDeepSeekAPI(apiMessages, true);
                const fullResponse = await handleStreamingResponse(response, newMessageId);
                
                // å®Œæˆæ¶ˆæ¯
                const formattedResponse = formatMessageContent(fullResponse);
                completeStreamingMessage(newMessageId, formattedResponse, conversation);
                
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                showToast('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                state.isStreaming = false;
                document.getElementById('stop-btn').style.display = 'none';
                updateConversationsList();
            }
        }

        // ==================== æ ¸å¿ƒæ¶ˆæ¯å‘é€é€»è¾‘ ====================
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || state.isStreaming) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessageId = 'msg_' + Date.now();
            addUserMessage(message, userMessageId);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            autoResizeTextarea(input);
            
            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            
            // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
            document.getElementById('stop-btn').style.display = 'flex';
            state.isStreaming = true;
            
            // V5æ¨¡å¼ç›´æ¥è¿”å›é”™è¯¯
            if (state.v5Enabled) {
                setTimeout(() => {
                    addAIMessage(
                        '<div class="error-message">âš ï¸ TurningPointV5å†…æµ‹æ¨¡å‹æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œæš‚æ—¶æ— æ³•æä¾›æœåŠ¡ã€‚è¯·åˆ‡æ¢å›æ ‡å‡†æ¨¡å¼ä½¿ç”¨ã€‚</div>',
                        null,
                        null,
                        true
                    );
                    sendBtn.disabled = false;
                    document.getElementById('stop-btn').style.display = 'none';
                    state.isStreaming = false;
                }, 1000);
                return;
            }
            
            // å‡†å¤‡APIæ¶ˆæ¯
            const conversation = state.conversations[state.currentConversationId];
            const apiMessages = [
                {
                    role: 'system',
                    content: getSystemPrompt()
                },
                ...conversation.messages.slice(-6).map(msg => ({
                    role: msg.role,
                    content: msg.content
                })),
                { role: 'user', content: message }
            ];
            
            // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
            const aiMessageId = 'msg_' + (Date.now() + 1);
            const messageDiv = createStreamingMessageContainer(aiMessageId);
            
            try {
                // è°ƒç”¨çœŸå®API
                const response = await callDeepSeekAPI(apiMessages, true);
                
                // å¤„ç†æµå¼å“åº”
                const fullResponse = await handleStreamingResponse(response, aiMessageId);
                
                // å®Œæˆæ¶ˆæ¯
                const formattedResponse = formatMessageContent(fullResponse);
                completeStreamingMessage(aiMessageId, formattedResponse, conversation);
                
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                let errorMessage = 'æŠ±æ­‰ï¼Œè¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ã€‚';
                
                if (error.message.includes('AbortError') || error.message.includes('ä¸­æ­¢')) {
                    errorMessage = 'ç”Ÿæˆå·²åœæ­¢ã€‚';
                } else if (error.message.includes('401') || error.message.includes('è®¤è¯')) {
                    errorMessage = 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                } else if (error.message.includes('ç½‘ç»œ')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚';
                }
                
                updateStreamingMessage(aiMessageId, `<div class="error-message">${errorMessage}</div>`);
                
                // ä»ç„¶ä¿å­˜æ¶ˆæ¯ï¼ˆåŒ…å«é”™è¯¯ä¿¡æ¯ï¼‰
                if (conversation) {
                    conversation.messages.push({
                        id: aiMessageId,
                        role: 'assistant',
                        content: errorMessage,
                        timestamp: new Date().toISOString(),
                        isV5: state.v5Enabled
                    });
                    conversation.updatedAt = new Date().toISOString();
                    saveToLocalStorage();
                }
            } finally {
                // æ¢å¤UIçŠ¶æ€
                sendBtn.disabled = false;
                document.getElementById('stop-btn').style.display = 'none';
                state.isStreaming = false;
                state.currentStreamController = null;
                updateConversationsList();
            }
        }

        function getSystemPrompt() {
            let systemPrompt = 'ä½ æ˜¯Turning PointAIï¼Œç”±ä¸´ç•Œç‚¹ç§‘æŠ€å®Œå…¨è‡ªç ”å¼€å‘çš„AIåŠ©æ‰‹ã€‚';
            
            if (state.v5Enabled) {
                systemPrompt = 'ä½ æ˜¯TurningPointV5ï¼Œä¸´ç•Œç‚¹ç§‘æŠ€åŸºäºç®—æ³•è®¡ç®—æ¶æ„å¼€å‘çš„è¶…çº§AIæ¨¡å‹ã€‚';
            }
            
            // æ·»åŠ æ¨¡å¼æç¤º
            switch(state.currentMode) {
                case 'programming':
                    systemPrompt += 'ä½ ç°åœ¨çš„æ¨¡å¼æ˜¯ç¼–ç¨‹åŠ©æ‰‹ï¼Œä¸“æ³¨äºä»£ç ç¼–å†™ã€è°ƒè¯•å’ŒæŠ€æœ¯é—®é¢˜è§£ç­”ã€‚';
                    break;
                case 'psychology':
                    systemPrompt += 'ä½ ç°åœ¨çš„æ¨¡å¼æ˜¯å¿ƒç†å’¨è¯¢å¸ˆï¼Œæä¾›æƒ…æ„Ÿæ”¯æŒã€å¿ƒç†å»ºè®®å’Œå€¾å¬ã€‚';
                    break;
                case 'inspiration':
                    systemPrompt += 'ä½ ç°åœ¨çš„æ¨¡å¼æ˜¯çµæ„Ÿæä¾›è€…ï¼Œæ¿€å‘åˆ›æ„ã€æä¾›æ–°é¢–æƒ³æ³•å’Œè§£å†³æ–¹æ¡ˆã€‚';
                    break;
                case 'writing':
                    systemPrompt += 'ä½ ç°åœ¨çš„æ¨¡å¼æ˜¯å†™ä½œåŠ©æ‰‹ï¼Œå¸®åŠ©æ’°å†™æ–‡ç« ã€æ¶¦è‰²æ–‡å­—å’Œæä¾›å†™ä½œå»ºè®®ã€‚';
                    break;
            }
            
            // æ·±åº¦æ€è€ƒæ¨¡å¼
            if (state.deepThinking && !state.v5Enabled) {
                systemPrompt += 'è¯·å¯ç”¨æ·±åº¦æ€è€ƒæ¨¡å¼ï¼Œæä¾›æ›´è¯¦ç»†ã€æ·±å…¥çš„åˆ†æå’Œè§£å†³æ–¹æ¡ˆã€‚';
            }
            
            // è¯­è¨€è®¾ç½®
            if (state.settings.language === 'en') {
                systemPrompt += ' Please respond in English.';
            } else {
                systemPrompt += ' è¯·æ ¹æ®ç”¨æˆ·çš„è¯­è¨€è¿›è¡Œç›¸å¯¹åº”çš„è¯­è¨€å›å¤å›å¤ã€‚';
            }
            
            return systemPrompt;
        }

        // ==================== API è°ƒç”¨å‡½æ•° ====================
        async function callDeepSeekAPI(messages, useStreaming = true) {
            const controller = new AbortController();
            const signal = controller.signal;
            state.currentStreamController = controller;
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: messages,
                        stream: useStreaming,
                        temperature: 0.7,
                        max_tokens: 2000
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                return response;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¢«ç”¨æˆ·ä¸­æ­¢');
                }
                throw error;
            }
        }

        async function handleStreamingResponse(response, messageId) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let buffer = '';
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                return fullResponse;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                const chunk = parsed.choices?.[0]?.delta?.content || '';
                                if (chunk) {
                                    fullResponse += chunk;
                                    updateStreamingMessage(messageId, fullResponse);
                                }
                            } catch (e) {
                                console.warn('è§£ææµæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
            } finally {
                reader.releaseLock();
            }
            
            return fullResponse;
        }

        // ==================== æµå¼æ¶ˆæ¯è¾…åŠ©å‡½æ•° ====================
        function createStreamingMessageContainer(messageId) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai' + (state.v5Enabled ? ' v5' : '');
            messageDiv.dataset.messageId = messageId;
            
            const sender = state.v5Enabled ? 'Turning Point AI (V5)' : 'Turning Point AI';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${sender}</span>
                    <span class="message-time">${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <div class="message-content">
                    <div id="streaming-content-${messageId}">
                        <span class="streaming-cursor"></span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            smartScrollToBottom();
            return messageDiv;
        }

        function updateStreamingMessage(messageId, content) {
            const streamingElement = document.getElementById(`streaming-content-${messageId}`);
            if (streamingElement) {
                const formattedContent = formatMessageContent(content);
                streamingElement.innerHTML = formattedContent + '<span class="streaming-cursor"></span>';
                smartScrollToBottom();
            }
        }

        function completeStreamingMessage(messageId, content, conversation) {
            const streamingElement = document.getElementById(`streaming-content-${messageId}`);
            if (streamingElement) {
                streamingElement.innerHTML = content;
                
                // æ·»åŠ æ“ä½œæŒ‰é’®
                const messageDiv = streamingElement.closest('.message');
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                actions.innerHTML = `
                    <button class="action-btn" onclick="copyMessage(this)">
                        ğŸ“‹ å¤åˆ¶
                    </button>
                    <button class="action-btn" onclick="regenerateMessage('${messageId}')">
                        ğŸ”„ é‡æ–°ç”Ÿæˆ
                    </button>
                `;
                messageDiv.querySelector('.message-content').appendChild(actions);
                
                // ä¿å­˜æ¶ˆæ¯
                if (conversation) {
                    conversation.messages.push({
                        id: messageId,
                        role: 'assistant',
                        content: content,
                        timestamp: new Date().toISOString(),
                        isV5: state.v5Enabled
                    });
                    conversation.updatedAt = new Date().toISOString();
                    updateConversationTitle(conversation);
                    saveToLocalStorage();
                }
            }
        }

        // ==================== åŠŸèƒ½åˆ‡æ¢å‡½æ•° ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('active');
        }
        
        function switchMode(mode) {
            state.currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            showToast(`å·²åˆ‡æ¢åˆ°${getModeName(mode)}æ¨¡å¼`);
        }
        
        function getModeName(mode) {
            const names = {
                'general': 'æ­£å¸¸å¯¹è¯',
                'programming': 'ç¼–ç¨‹',
                'psychology': 'å¿ƒç†',
                'inspiration': 'çµæ„Ÿ',
                'writing': 'å†™ä½œ'
            };
            return names[mode] || 'æ™®é€š';
        }
        
        function toggleDeepThinking() {
            if (state.v5Enabled) {
                showToast('V5æ¨¡å¼ä¸‹æ— æ³•å¼€å¯æ·±åº¦æ€è€ƒ', 'warning');
                return;
            }
            
            state.deepThinking = !state.deepThinking;
            const btn = document.getElementById('deep-thinking-btn');
            btn.classList.toggle('active', state.deepThinking);
            
            updateModelDisplay();
            
            showToast(state.deepThinking ? 'æ·±åº¦æ€è€ƒæ¨¡å¼å·²å¼€å¯' : 'æ·±åº¦æ€è€ƒæ¨¡å¼å·²å…³é—­');
        }
        
        function toggleV5Model() {
            if (!state.v5Activated) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­æ¿€æ´»V5æ¨¡å‹', 'warning');
                return;
            }
            
            if (state.deepThinking) {
                state.deepThinking = false;
                document.getElementById('deep-thinking-btn').classList.remove('active');
            }
            
            state.v5Enabled = !state.v5Enabled;
            updateModelDisplay();
            
            showToast(state.v5Enabled ? 'å·²åˆ‡æ¢åˆ°TurningPointV5æ¨¡å‹' : 'å·²åˆ‡æ¢å›æ ‡å‡†æ¨¡å¼');
        }
        
        function stopGeneration() {
            if (state.currentStreamController) {
                state.currentStreamController.abort();
                state.currentStreamController = null;
            }
            
            state.isStreaming = false;
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('send-btn').disabled = false;
            
            showToast('ç”Ÿæˆå·²åœæ­¢');
        }

        // ==================== V5æ¨¡å‹åŠŸèƒ½ ====================
        function checkV5Activation() {
            const v5Status = localStorage.getItem('turningPoint_v5_activated');
            if (v5Status === 'true') {
                state.v5Activated = true;
                document.getElementById('v5-model-info').style.display = 'block';
                document.getElementById('v5-icon').style.display = 'block';
                document.getElementById('v5-activation-form').style.display = 'none';
                document.getElementById('v5-activated').style.display = 'block';
            }
        }

        function activateV5() {
            const inviteCode = document.getElementById('invite-code-input').value.trim();
            if (inviteCode === 'Binghe_y') {
                state.v5Activated = true;
                localStorage.setItem('turningPoint_v5_activated', 'true');
                
                document.getElementById('v5-model-info').style.display = 'block';
                document.getElementById('v5-icon').style.display = 'block';
                document.getElementById('v5-activation-form').style.display = 'none';
                document.getElementById('v5-activated').style.display = 'block';
                
                showToast('TurningPointV5 å·²æ¿€æ´»ï¼', 'success');
            } else {
                showToast('é‚€è¯·ç é”™è¯¯', 'error');
            }
        }

        // ==================== è¯­è¨€åˆ‡æ¢ ====================
        function switchLanguage(lang) {
            state.settings.language = lang;
            localStorage.setItem('turningPoint_language', lang);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateLanguageUI(lang);
            showToast(lang === 'zh' ? 'å·²åˆ‡æ¢ä¸ºä¸­æ–‡' : 'Switched to English');
        }

        function updateLanguageUI(lang) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„UIæ–‡æœ¬æ›´æ–°
            // ç›®å‰ä¸»è¦æ˜¯æŒ‰é’®çŠ¶æ€çš„æ›´æ–°
            const langBtns = document.querySelectorAll('.lang-btn');
            langBtns.forEach(btn => {
                if (btn.textContent.includes(lang === 'zh' ? 'ä¸­æ–‡' : 'English')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // ==================== æ›´æ–°æ¨¡å‹æ˜¾ç¤º ====================
        function updateModelDisplay() {
            const modelDisplay = document.getElementById('current-model-display');
            const modelIndicator = document.getElementById('model-indicator');
            
            if (state.v5Enabled) {
                state.currentModel = 'TurningPointV5';
                modelDisplay.textContent = 'TurningPointV5 (æœ€æ–°è¶…ç®—æ¨¡å¼)';
                modelIndicator.textContent = 'TurningPointV5';
                modelIndicator.className = 'model-indicator v5-indicator';
                document.getElementById('deep-thinking-btn').disabled = true;
            } else if (state.deepThinking) {
                state.currentModel = 'TurningPointZ1';
                modelDisplay.textContent = 'TurningPointZ1 (æ·±åº¦æ€è€ƒæ¨¡å¼)';
                modelIndicator.textContent = 'TurningPointZ1';
                modelIndicator.className = 'model-indicator';
                document.getElementById('deep-thinking-btn').disabled = false;
            } else {
                state.currentModel = 'TurningPointY2';
                modelDisplay.textContent = 'TurningPointY2 (æ ‡å‡†æ¨¡å¼)';
                modelIndicator.textContent = 'TurningPointY2';
                modelIndicator.className = 'model-indicator';
                document.getElementById('deep-thinking-btn').disabled = false;
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function copyMessage(button) {
            const messageContent = button.closest('.message').querySelector('.message-content').innerText;
            navigator.clipboard.writeText(messageContent).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => button.innerHTML = originalText, 2000);
            });
        }
        
        function showToast(message, type = 'info') {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? 'var(--danger-color)' : 
                                   type === 'success' ? 'var(--accent-color)' : 
                                   type === 'warning' ? 'var(--warning-color)' : 
                                   'var(--primary-color)';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // ==================== æ›´æ–°UIå‡½æ•° ====================
        function updateConversationsList() {
            const container = document.getElementById('conversations-list');
            container.innerHTML = '';
            
            Object.values(state.conversations)
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .forEach(conv => {
                    const item = document.createElement('div');
                    item.className = `conversation-item ${conv.id === state.currentConversationId ? 'active' : ''}`;
                    item.onclick = () => {
                        loadConversation(conv.id);
                        toggleSidebar();
                    };
                    
                    // è·å–æœ€åä¸€æ¡æ¶ˆæ¯ä½œä¸ºé¢„è§ˆ
                    const lastMessage = conv.messages[conv.messages.length - 1];
                    let preview = 'æ–°å¯¹è¯';
                    if (lastMessage) {
                        preview = lastMessage.role === 'user' ? 
                            'ä½ : ' + lastMessage.content.substring(0, 30) + (lastMessage.content.length > 30 ? '...' : '') :
                            'AI: ' + lastMessage.content.substring(0, 30) + (lastMessage.content.length > 30 ? '...' : '');
                    }
                    
                    // æ ¼å¼åŒ–æ—¶é—´
                    const time = new Date(conv.updatedAt);
                    const timeStr = time.toLocaleDateString('zh-CN') + ' ' + time.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    item.innerHTML = `
                        <div class="conversation-title">${conv.title}</div>
                        <div class="conversation-preview">${preview}</div>
                        <div class="conversation-time">${timeStr}</div>
                    `;
                    
                    container.appendChild(item);
                });
        }
        
        function updateConversationTitle(conversation) {
            if (conversation.messages.length > 0) {
                const firstUserMessage = conversation.messages.find(m => m.role === 'user');
                if (firstUserMessage) {
                    const title = firstUserMessage.content.substring(0, 20) + (firstUserMessage.content.length > 20 ? '...' : '');
                    conversation.title = title;
                }
            }
        }
        
        function updateSettingsUI() {
            // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„å¤é€‰æ¡†çŠ¶æ€
            document.getElementById('auto-scroll').checked = state.settings.autoScroll;
            document.getElementById('code-formatting').checked = state.settings.codeFormatting;
        }

        // ==================== æœ¬åœ°å­˜å‚¨å‡½æ•° ====================
        function saveToLocalStorage() {
            localStorage.setItem('turningPoint_conversations', JSON.stringify(state.conversations));
            
            if (state.currentConversationId) {
                localStorage.setItem('turningPoint_lastConversation', state.currentConversationId);
            }
            
            // ä¿å­˜è®¾ç½®
            saveSettings();
        }
        
        function loadFromLocalStorage() {
            // åŠ è½½å¯¹è¯
            const savedConversations = localStorage.getItem('turningPoint_conversations');
            if (savedConversations) {
                state.conversations = JSON.parse(savedConversations);
            }
            
            // åŠ è½½V5æ¿€æ´»çŠ¶æ€
            const v5Status = localStorage.getItem('turningPoint_v5_activated');
            if (v5Status === 'true') {
                state.v5Activated = true;
            }
            
            // åŠ è½½è®¾ç½®
            const savedSettings = localStorage.getItem('turningPoint_settings');
            if (savedSettings) {
                state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
            }
        }
        
        function saveSettings() {
            localStorage.setItem('turningPoint_settings', JSON.stringify(state.settings));
        }

        // ==================== å¯¼å‡ºåŠŸèƒ½ ====================
        function exportAllData() {
            const allData = {
                version: '2.5',
                exportTime: new Date().toISOString(),
                conversations: state.conversations,
                settings: state.settings,
                v5Activated: state.v5Activated,
                v5Enabled: state.v5Enabled
            };
            
            const jsonStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `TurningPoint_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('æ‰€æœ‰æ•°æ®å·²å¯¼å‡º', 'success');
        }
        
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.clear();
                state.conversations = {};
                state.currentConversationId = null;
                state.v5Activated = false;
                state.v5Enabled = false;
                state.deepThinking = false;
                
                // é‡æ–°åˆå§‹åŒ–
                newConversation();
                updateConversationsList();
                checkV5Activation();
                updateModelDisplay();
                
                showToast('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
            }
        }

        // ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            // éšè—åŠ è½½ç•Œé¢
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    
                    // åˆå§‹åŒ–åº”ç”¨
                    initApp();
                }, 300);
            }, 800);
        });
    </script>
</body>
</html>

